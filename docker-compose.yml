version: "3.9"

services:
  taxprotest:
    image: taxprotest:latest
    build: .
    container_name: taxprotest
    environment:
      TAXPROTEST_SECRET_KEY: "change-me"
      TAXPROTEST_DEBUG: "0"
      TAXPROTEST_HOST: "0.0.0.0"
      TAXPROTEST_PORT: "8000"
    ports:
      - "5001:8000"
    volumes:
      - data_volume:/app/data
      - exports_volume:/app/Exports
    restart: unless-stopped

  refresh:
    image: taxprotest:latest
    build: .
    depends_on:
      - taxprotest
    # Runs the smart orchestrator then exits (use: docker compose run --rm refresh)
    command: ["python", "refresh.py"]
    volumes:
      - data_volume:/app/data
      - exports_volume:/app/Exports
    profiles: ["maintenance"]
    # Optional basic healthcheck (adds ~3â€“5 MB if curl not present; if you add curl to image)
    # healthcheck:
    #   test: ["CMD", "wget", "-qO", "-", "http://localhost:8000/health"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 20s

# Add a named volume section if you prefer docker-managed volumes instead of bind mounts:
volumes:
  data_volume:
  exports_volume:
