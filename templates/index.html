{% extends "base.html" %}
{% block title %}HCAD Property Search{% endblock %}
{% block content %}
<div class="row mb-4">
  <div class="col-lg-10 mx-auto">
    <div class="card">
      <div class="card-header bg-primary text-white">Search Properties</div>
      <div class="card-body">
        <form method="post" class="row g-3 align-items-end" id="search-form">
          {{ form.hidden_tag() }}
          <div class="col-sm-4">
            {{ form.acct.label(class_="form-label") }}
            {{ form.acct(class_="form-control") }}
          </div>
          <div class="col-sm-4">
            {{ form.owner.label(class_="form-label") }}
            {{ form.owner(class_="form-control") }}
          </div>
          <div class="col-sm-3">
            {{ form.street.label(class_="form-label") }}
            {{ form.street(class_="form-control") }}
          </div>
          <div class="col-sm-2">
            {{ form.zip_code.label(class_="form-label") }}
            {{ form.zip_code(class_="form-control") }}
          </div>
          <div class="col-sm-3 form-check mt-4 ms-2">
            {{ form.exact_match(class_="form-check-input") }} {{ form.exact_match.label(class_="form-check-label") }}
          </div>
          <div class="col-sm-2">
            <label for="page_size" class="form-label">Page Size</label>
            <select name="page_size" id="page_size" class="form-select">
              {% for ps in allowed_page_sizes %}
                <option value="{{ ps }}" {% if ps == page_size %}selected{% endif %}>{{ ps }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            {{ form.submit(class_="btn btn-primary") }}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% if results %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white">Results ({{ results|length }})</div>
        <div class="table-responsive">
          <div class="p-2 d-flex justify-content-between flex-wrap gap-2">
            <div class="small text-muted">Showing {{ (page-1)*page_size + 1 if results and total>0 else 0 }} - {{ (page-1)*page_size + results|length if results }} of {{ total }}</div>
            <div class="d-flex align-items-center gap-2">
              <label for="client-filter" class="form-label mb-0 small">Filter current page</label>
              <input id="client-filter" type="text" class="form-control form-control-sm minw-200" placeholder="Type to filter...">
              <span class="badge bg-info text-dark d-none" id="filter-count"></span>
            </div>
          </div>
          <table class="table table-sm table-striped table-hover mb-0" id="results-table">
            <thead class="table-light">
              <tr>
                <th>Acct</th><th>Owner</th><th>Address</th><th>Year</th><th>Beds</th><th>Baths</th><th>Sty</th><th>PPSF</th><th>Value</th><th>Amenities</th><th>Comps</th>
              </tr>
            </thead>
            <tbody>
            {% for r in results %}
              <tr>
                <td>{{ r.get('acct')|highlight(search_params.acct if search_params else '') }}</td>
                <td>{% if search_params %}{{ r.get('owner_name','')|highlight(search_params.owner) }}{% else %}{{ r.get('owner_name','') }}{% endif %}</td>
                <td>{% if search_params %}{{ (r.get('site_addr_1','') ~ ' ' ~ r.get('site_addr_3',''))|highlight(search_params.street) }}{% else %}{{ r.get('site_addr_1','') }} {{ r.get('site_addr_3','') }}{% endif %}</td>
                <td>{{ r.get('build_year') }}</td>
                <td>{{ r.get('bedrooms') }}</td>
                <td>{{ r.get('bathrooms') }}</td>
                <td>{{ r.get('stories') }}</td>
                <td>{% if r.get('ppsf') %}${{ '%.2f'|format(r.get('ppsf')) }}{% else %}-{% endif %}</td>
                <td>{% if r.get('market_value') %}${{ '{:,.0f}'.format(r.get('market_value')|float) }}{% else %}-{% endif %}</td>
                <td class="text-truncate truncate-180">{{ r.get('amenities','') }}</td>
                <td><a class="btn btn-outline-primary btn-sm show-loading" href="{{ url_for('main.comparables', acct=r.get('acct')) }}">View</a></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card-body">
          <a class="btn btn-success" href="{{ url_for('main.download') }}">Download results (Excel)</a>
          {% import 'macros.html' as m %}
          {{ m.pagination('main.index', page, total_pages, page_size, search_params, allowed_page_sizes) }}
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
{% block extra_scripts %}
<script>
// Auto-submit on page size change
document.getElementById('page_size')?.addEventListener('change', function(){
  const form = document.getElementById('search-form');
  if(form){ form.requestSubmit(); }
});

// Client-side filtering for current page
const filterInput = document.getElementById('client-filter');
const table = document.getElementById('results-table');
const counter = document.getElementById('filter-count');
if(filterInput && table){
  filterInput.addEventListener('input', function(){
    const q = this.value.trim().toLowerCase();
    let visible = 0; let totalRows = 0;
    table.querySelectorAll('tbody tr').forEach(tr => {
      totalRows++;
      if(!q){ tr.style.display=''; visible++; return; }
      const text = tr.textContent.toLowerCase();
      if(text.indexOf(q) !== -1){ tr.style.display=''; visible++; } else { tr.style.display='none'; }
    });
    if(q){
  counter.classList.remove('d-none');
      counter.textContent = visible + ' / ' + totalRows;
    } else {
  counter.classList.add('d-none');
    }
  });
}
</script>
{% endblock %}
