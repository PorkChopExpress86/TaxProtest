{% extends "base.html" %}
{% block title %}Comparables - {{ acct }}{% endblock %}
{% block content %}
<div class="row mb-4">
  <div class="col-lg-10 mx-auto">
  <a class="btn btn-link show-loading" href="/">&larr; Back to Search</a>
    <h2>Comparables for <code>{{ acct }}</code></h2>
    {% if meta %}
    <div class="alert alert-info small mb-2">
      <div>
        <strong>Geo:</strong> {{ meta.geo_tier or 'n/a' }}{% if meta.radius_miles %} ({{ meta.radius_miles }} mi){% endif %}
        | <strong>Size</strong> {{ meta.size_band or 'n/a' }}
        | <strong>Lot</strong> {{ meta.lot_band or 'n/a' }}
        | <strong>Year</strong> {{ meta.year_band or 'n/a' }}
        | <strong>Beds/Baths</strong> {{ meta.bed_bath_band or 'n/a' }}
        | <strong>Stories</strong> {{ meta.story_band or 'n/a' }}
        | <strong>Pool</strong> {{ meta.pool_rule or 'n/a' }}
        | <strong>Garage</strong> {{ meta.garage_rule or 'n/a' }}
        | <strong>Attempts</strong> {{ meta.attempts }}
      </div>
      {% if meta.baseline and meta.relaxed %}
      <div class="mt-1">
        <strong>Relaxed:</strong>
        {% for k,v in meta.relaxed.items() %}
          {% if k in ['size_band','lot_band','year_band','bed_bath_band','story_band','pool_rule','garage_rule'] %}
            <span class="badge bg-{{ 'danger' if v else 'success' }} me-1">{{ k.replace('_',' ') }} {{ 'relaxed' if v else 'base' }}</span>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
      {% if meta.scoring_weights %}
      <div class="mt-1">
        <strong>Weights:</strong> dist {{ meta.scoring_weights.distance }}, size {{ meta.scoring_weights.size }}, year {{ meta.scoring_weights.year }}, beds/baths {{ meta.scoring_weights.beds_baths }}, stories {{ meta.scoring_weights.stories }}, pool/gar {{ meta.scoring_weights.pool_garage }}
      </div>
      {% endif %}
    </div>
  <form method="get" class="row g-2 align-items-end mb-3" action="{{ url_for('main.comparables', acct=acct) }}">
      <div class="col-auto">
        <label class="form-label mb-0 small">Min comps</label>
  <input type="number" class="form-control form-control-sm" name="min" value="{{ cfg.min if cfg else 20 }}" min="1" max="50" placeholder="min" title="Minimum desired comparables" />
      </div>
      <div class="col-auto">
        <label class="form-label mb-0 small">Max comps</label>
  <input type="number" class="form-control form-control-sm" name="max" value="{{ cfg.max if cfg else 25 }}" min="1" max="50" placeholder="max" title="Maximum comparables to return" />
      </div>
      <div class="col-auto">
        <label class="form-label mb-0 small">Max radius (mi)</label>
  <input type="number" step="0.1" class="form-control form-control-sm" name="max_radius" value="{{ cfg.max_radius if cfg and cfg.max_radius is not none else '' }}" placeholder="(default)" title="Cap search radius (miles)" />
      </div>
      <div class="col-auto form-check mt-4 pt-1">
        <input class="form-check-input" type="checkbox" id="strict_first" name="strict_first" value="1" {% if cfg.strict_first %}checked{% endif %} />
        <label class="form-check-label small" for="strict_first">Strict pass first</label>
      </div>
      <div class="col-auto mt-4 pt-1">
  <button type="submit" class="btn btn-sm btn-primary">Recompute</button>
      </div>
    </form>
    {% if comparables %}
    <div class="mb-3">
  <a class="btn btn-sm btn-outline-success me-2" href="{{ url_for('main.export_comparables_route', acct=acct, fmt='xlsx', max=cfg.max, min=cfg.min, max_radius=cfg.max_radius, strict_first=1 if cfg.strict_first else 0) }}">Export Excel</a>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.export_comparables_route', acct=acct, fmt='csv', max=cfg.max, min=cfg.min, max_radius=cfg.max_radius, strict_first=1 if cfg.strict_first else 0) }}">Export CSV</a>
    </div>
    {% endif %}
    {% endif %}
  </div>
</div>

{% if meta.pricing_stats %}
<div class="row mb-3">
  <div class="col-lg-10 mx-auto">
    <div class="card small">
      <div class="card-header bg-info text-white">Pricing Summary</div>
      <div class="card-body">
        {% set ps = meta.pricing_stats %}
        <div class="row">
          <div class="col-md-6">
            <strong>Market Value (n={{ ps.value_stats.count if ps.value_stats }})</strong><br/>
            Median: {{ ps.value_stats.median if ps.value_stats }} &nbsp; Mean: {{ ps.value_stats.mean if ps.value_stats }}<br/>
            Min/Max: {{ ps.value_stats.min if ps.value_stats }}/{{ ps.value_stats.max if ps.value_stats }} &nbsp; IQR: {{ ps.value_stats.iqr if ps.value_stats }}<br/>
            Subject Δ vs Median: {{ ps.subject_vs_value.diff_vs_median if ps.subject_vs_value }} ({{ ps.subject_vs_value.pct_vs_median if ps.subject_vs_value }}%)
          </div>
          <div class="col-md-6">
            <strong>PPSF (n={{ ps.ppsf_stats.count if ps.ppsf_stats }})</strong><br/>
            Median: {{ ps.ppsf_stats.median if ps.ppsf_stats }} &nbsp; Mean: {{ ps.ppsf_stats.mean if ps.ppsf_stats }}<br/>
            Min/Max: {{ ps.ppsf_stats.min if ps.ppsf_stats }}/{{ ps.ppsf_stats.max if ps.ppsf_stats }} &nbsp; IQR: {{ ps.ppsf_stats.iqr if ps.ppsf_stats }}<br/>
            Subject Δ vs Median: {{ ps.subject_vs_ppsf.diff_vs_median if ps.subject_vs_ppsf }} ({{ ps.subject_vs_ppsf.pct_vs_median if ps.subject_vs_ppsf }}%)<br/>
            Within ±10% of Subject: {{ ps.ppsf_band_counts.within_10pct if ps.ppsf_band_counts }}/{{ ps.ppsf_stats.count if ps.ppsf_stats }} comps
          </div>
        </div>
        <div class="mt-2 small text-muted">
          {% if ps.pool_match_rate %}Pool match rate: {{ ps.pool_match_rate }}% &nbsp;{% endif %}
          {% if ps.garage_match_rate %}Garage match rate: {{ ps.garage_match_rate }}% &nbsp;{% endif %}
          {% if ps.trimmed_ppsf_median %}Trimmed PPSF Median: {{ ps.trimmed_ppsf_median }}{% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if subject %}
<div class="row mb-4">
  <div class="col-lg-10 mx-auto">
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">Subject Property</div>
      <div class="card-body">
  <div><strong>Address:</strong> {{ subject.get('site_addr_1','') }} {{ subject.get('site_addr_3','') }}</div>
  <div class="small text-muted"><strong>Owner:</strong> {{ subject.get('owner_name','') }}</div>
  <div class="small"><strong>Appraised (Market) Value:</strong> {% if subject.get('market_value') %}${{ '{:,.0f}'.format(subject.get('market_value')|float) }}{% else %}-{% endif %}</div>
  <div class="small"><strong>Land / Building Area:</strong> {{ subject.get('land_area') or '-' }} / {{ subject.get('building_area') or '-' }}</div>
  <div class="small"><strong>Beds/Baths:</strong> {{ subject.get('bedrooms') }} / {{ subject.get('bathrooms') }} &nbsp; <strong>Stories:</strong> {{ subject.get('stories') or '-' }} &nbsp; <strong>Pool:</strong> {{ 'Y' if subject.get('has_pool')==1 else ('N' if subject.get('has_pool')==0 else '-') }} &nbsp; <strong>Garage:</strong> {{ 'Y' if subject.get('has_garage')==1 else ('N' if subject.get('has_garage')==0 else '-') }}</div>
  <div class="small"><strong>Year:</strong> {{ subject.get('build_year') or '-' }} &nbsp; <strong>PPSF:</strong> {% if subject.get('ppsf') %}${{ '%.2f'|format(subject.get('ppsf')) }}{% else %}-{% endif %}</div>
  <div class="small"><strong>Type:</strong> {{ subject.get('property_type') or '-' }} &nbsp; <strong>Rating:</strong> {{ subject.get('overall_rating') or '-' }}</div>
  <div class="small text-truncate truncate-400"><strong>Amenities:</strong> {{ subject.get('amenities','') }}</div>
  {% if subject.get('rating_explanation') %}<div class="small text-muted"><em>{{ subject.get('rating_explanation') }}</em></div>{% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header bg-secondary text-white">Comparable Properties ({{ comparables|length if comparables else 0 }})</div>
      {% if comparables %}
      <div class="table-responsive">
        <table class="table table-sm table-striped table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Acct</th><th>Score</th><th>Address</th><th>Year</th><th>Beds</th><th>Baths</th><th>Sty</th><th>P</th><th>G</th><th>PPSF</th><th>Value</th><th>Amenities</th><th>Dist (mi)</th>
            </tr>
          </thead>
          <tbody>
            {% for c in comparables %}
            <tr>
              <td>{{ c.get('acct') }}</td>
              <td>{{ c.get('score') }}</td>
              <td>{{ c.get('site_addr_1','') }} {{ c.get('site_addr_3','') }}</td>
              <td>{{ c.get('build_year') }}</td>
              <td>{{ c.get('bedrooms') }}</td>
              <td>{{ c.get('bathrooms') }}</td>
              <td>{{ c.get('stories') if c.get('stories') is not none else '' }}</td>
              <td>{% if c.get('has_pool')==1 %}Y{% elif c.get('has_pool')==0 %}N{% else %}{% endif %}</td>
              <td>{% if c.get('has_garage')==1 %}Y{% elif c.get('has_garage')==0 %}N{% else %}{% endif %}</td>
              <td>{% if c.get('ppsf') %}${{ '%.2f'|format(c.get('ppsf')) }}{% else %}-{% endif %}</td>
              <td>{% if c.get('market_value') %}${{ '{:,.0f}'.format(c.get('market_value')|float) }}{% else %}-{% endif %}</td>
              <td class="text-truncate truncate-200">{{ c.get('amenities','') }}</td>
              <td>{{ '%.2f'|format(c.get('distance_miles',0)) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="small text-muted p-2 border-top">
          <strong>Legend:</strong>
          Acct = Account ID; Score = Composite similarity score (0-100, higher is closer);
          Beds = Bedrooms; Baths = Bathrooms; Sty = Stories; P = Pool (Y/N); G = Garage (Y/N);
          PPSF = Market Value per Sq Ft of building area; Dist (mi) = Distance in miles.
        </div>
      </div>
      {% else %}
        <div class="card-body">
          <p class="mb-0">No comparables found.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
