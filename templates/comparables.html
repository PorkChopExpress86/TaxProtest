{% extends "base.html" %}
{% block title %}Comparables - {{ acct }}{% endblock %}
{% block content %}
<div class="row mb-4">
  <div class="col-lg-10 mx-auto">
  <a class="btn btn-link show-loading" href="/">&larr; Back to Search</a>
    <h2>Comparables for <code>{{ acct }}</code></h2>
    {% if meta %}
    <div class="alert alert-info small mb-0">
      Geo: {{ meta.geo_tier or 'n/a' }}{% if meta.radius_miles %} ({{ meta.radius_miles }} mi){% endif %}
  | Size {{ meta.size_band or 'n/a' }}, Lot {{ meta.lot_band or 'n/a' }}, Year {{ meta.year_band or 'n/a' }}, Beds/Baths {{ meta.bed_bath_band or 'n/a' }}
      | Stories {{ meta.story_band or 'n/a' }}, Pool {{ meta.pool_rule or 'n/a' }}, Garage {{ meta.garage_rule or 'n/a' }}
      | Attempts {{ meta.attempts }}
  {% if meta.scoring_weights %}<br/>Weights: dist {{ meta.scoring_weights.distance }}, size {{ meta.scoring_weights.size }}, year {{ meta.scoring_weights.year }}, beds/baths {{ meta.scoring_weights.beds_baths }}, stories {{ meta.scoring_weights.stories }}, pool/gar {{ meta.scoring_weights.pool_garage }}{% endif %}
    </div>
    {% endif %}
  </div>
</div>

{% if subject %}
<div class="row mb-4">
  <div class="col-lg-10 mx-auto">
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">Subject Property</div>
      <div class="card-body">
  <div><strong>Address:</strong> {{ subject.get('site_addr_1','') }} {{ subject.get('site_addr_3','') }}</div>
  <div class="small text-muted"><strong>Owner:</strong> {{ subject.get('owner_name','') }}</div>
  <div class="small"><strong>Appraised (Market) Value:</strong> {% if subject.get('market_value') %}${{ '{:,.0f}'.format(subject.get('market_value')|float) }}{% else %}-{% endif %}</div>
  <div class="small"><strong>Land / Building Area:</strong> {{ subject.get('land_area') or '-' }} / {{ subject.get('building_area') or '-' }}</div>
  <div class="small"><strong>Beds/Baths:</strong> {{ subject.get('bedrooms') }} / {{ subject.get('bathrooms') }} &nbsp; <strong>Stories:</strong> {{ subject.get('stories') or '-' }} &nbsp; <strong>Pool:</strong> {{ 'Y' if subject.get('has_pool')==1 else ('N' if subject.get('has_pool')==0 else '-') }} &nbsp; <strong>Garage:</strong> {{ 'Y' if subject.get('has_garage')==1 else ('N' if subject.get('has_garage')==0 else '-') }}</div>
  <div class="small"><strong>Year:</strong> {{ subject.get('build_year') or '-' }} &nbsp; <strong>PPSF:</strong> {% if subject.get('ppsf') %}${{ '%.2f'|format(subject.get('ppsf')) }}{% else %}-{% endif %}</div>
  <div class="small"><strong>Type:</strong> {{ subject.get('property_type') or '-' }} &nbsp; <strong>Rating:</strong> {{ subject.get('overall_rating') or '-' }}</div>
  <div class="small text-truncate truncate-400"><strong>Amenities:</strong> {{ subject.get('amenities','') }}</div>
  {% if subject.get('rating_explanation') %}<div class="small text-muted"><em>{{ subject.get('rating_explanation') }}</em></div>{% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header bg-secondary text-white">Comparable Properties ({{ comparables|length if comparables else 0 }})</div>
      {% if comparables %}
      <div class="table-responsive">
        <table class="table table-sm table-striped table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Acct</th><th>Score</th><th>Address</th><th>Year</th><th>Beds</th><th>Baths</th><th>Sty</th><th>P</th><th>G</th><th>PPSF</th><th>Value</th><th>Amenities</th><th>Dist (mi)</th>
            </tr>
          </thead>
          <tbody>
            {% for c in comparables %}
            <tr>
              <td>{{ c.get('acct') }}</td>
              <td>{{ c.get('score') }}</td>
              <td>{{ c.get('site_addr_1','') }} {{ c.get('site_addr_3','') }}</td>
              <td>{{ c.get('build_year') }}</td>
              <td>{{ c.get('bedrooms') }}</td>
              <td>{{ c.get('bathrooms') }}</td>
              <td>{{ c.get('stories') if c.get('stories') is not none else '' }}</td>
              <td>{% if c.get('has_pool')==1 %}Y{% elif c.get('has_pool')==0 %}N{% else %}{% endif %}</td>
              <td>{% if c.get('has_garage')==1 %}Y{% elif c.get('has_garage')==0 %}N{% else %}{% endif %}</td>
              <td>{% if c.get('ppsf') %}${{ '%.2f'|format(c.get('ppsf')) }}{% else %}-{% endif %}</td>
              <td>{% if c.get('market_value') %}${{ '{:,.0f}'.format(c.get('market_value')|float) }}{% else %}-{% endif %}</td>
              <td class="text-truncate truncate-200">{{ c.get('amenities','') }}</td>
              <td>{{ '%.2f'|format(c.get('distance_miles',0)) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="small text-muted p-2 border-top">
          <strong>Legend:</strong>
          Acct = Account ID; Score = Composite similarity score (0-100, higher is closer);
          Beds = Bedrooms; Baths = Bathrooms; Sty = Stories; P = Pool (Y/N); G = Garage (Y/N);
          PPSF = Market Value per Sq Ft of building area; Dist (mi) = Distance in miles.
        </div>
      </div>
      {% else %}
        <div class="card-body">
          <p class="mb-0">No comparables found.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
